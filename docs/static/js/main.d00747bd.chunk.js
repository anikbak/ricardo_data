(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{353:function(e,t){},361:function(e,t,a){e.exports=a(953)},372:function(e,t,a){},627:function(e,t){},629:function(e,t){},661:function(e,t){},662:function(e,t){},71:function(e){e.exports={b:"https://raw.githubusercontent.com/medialab/ricardo_data/master",a:"https://api.github.com/repos/medialab/ricardo_data/contents"}},787:function(e,t,a){var n={"./geojson.json":314,"./table-schema.json":788,"./topojson.json":315};function r(e){var t=o(e);return a(t)}function o(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=o,e.exports=r,r.id=787},850:function(e,t,a){var n={"./data-package.json":851,"./data-resource.json":852,"./fiscal-data-package.json":853,"./registry.json":854,"./tabular-data-package.json":855,"./tabular-data-resource.json":856};function r(e){var t=o(e);return a(t)}function o(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=o,e.exports=r,r.id=850},921:function(e,t,a){var n={"./geojson.json":348,"./table-schema.json":922,"./topojson.json":349};function r(e){var t=o(e);return a(t)}function o(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=o,e.exports=r,r.id=921},950:function(e,t){},951:function(e,t){},953:function(e,t,a){"use strict";a.r(t);var n=a(0),r=a.n(n),o=a(87),c=a.n(o),s=a(39),l=(a(372),a(124)),i=a(125),u=a(127),d=a(126),m=a(128),f=a(12),p=a(129),h=a(71),E=a(88),v="FETCH_DATAPACKAGE_SUCCESS",b="FETCH_TABLES_SUCCESS",y=[{name:"sources",path:"data/sources.csv"},{name:"currencies",path:"data/currencies.csv"},{name:"entity_names",path:"data/entity_names.csv"},{name:"expimp_spegen",path:"data/expimp_spegen.csv"}],g={};var j=function(e){function t(){return Object(l.a)(this,t),Object(u.a)(this,Object(d.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(i.a)(t,[{key:"componentDidMount",value:function(){this.props.fetchDatapackage(),this.props.fetchAllTables({branch:"master"})}},{key:"render",value:function(){var e=this.props.repoData;return r.a.createElement("div",null,!e.tables&&r.a.createElement("span",null,"loading tables"),!e.datapackage&&r.a.createElement("span",null,"loading datapackage"))}}]),t}(r.a.Component),O=Object(s.b)(function(e){return{repoData:e.repoData}},{fetchAllTables:function(e){return function(t){var a=e.branch;t({type:"FETCH_TABLES_REQUEST"}),Promise.all(y.map(function(e){return Object(p.get)("".concat(h.a,"/").concat(e.path,"?ref=").concat(a))})).then(function(e){var a={};e.forEach(function(e){var t=e.data.name.split(".")[0];a[t]=e.data}),t({type:b,payload:a})}).catch(function(a){return t({type:"FETCH_TABLES_FAILURE",payload:e,error:a})})}},fetchDatapackage:function(){return function(e){return e({type:"FETCH_DATAPACKAGE_REQUEST"}),Object(p.get)("".concat(h.a,"/datapackage.json?ref=master")).then(function(t){return e({type:v,payload:t.data})}).catch(function(t){return e({type:"FETCH_DATAPACKAGE_FAILURE",error:t})})}}})(j),w=a(360),k=a(9),A="UPDATE_FLOW",x="IMPORT_FLOWS",C={};var S="SET_STEP",_=function(e){return{type:S,payload:e}},R=[{id:"0",name:"Upload file",title:"Choose a file"},{id:"1",name:"Schema Validation",title:"Schema validation against datapackage"}],F={steps:R,selectedStep:R[0]};var T=a(8),N=a.n(T),D=a(130),L=(a(622),a(357),a(189)),V=a(89),B="VALIDATE_TABLE_REQUEST",H="VALIDATE_TABLE_SUCCESS",U="VALIDATE_TABLE_FAILURE",I="VALIDATE_HEADER_REQUEST",K="VALIDATE_HEADER_SUCCESS",P="VALIDATE_HEADER_FAILURE",M={tableValidated:"flows",schemaFeedback:null,headerFeedback:null,tables:null};var W=function(e){var t=e.schemaValidation.tableValidated;return e.schemaValidation.descriptor.resources.find(function(e){return e.name===t}).schema},G=function(e){var t=J(e),a={};return t.forEach(function(t){var n=t.reference.resource;a[n]=e.schemaValidation.tables[n]}),a},J=function(e){var t=e.schemaValidation.tableValidated;return e.schemaValidation.descriptor.resources.find(function(e){return e.name===t}).schema.foreignKeys},Q=a(54),Y=function(e){var t,a=e.headerNames,n=e.fieldNames,o=a.length-n.length;t=o>0?Object(Q.difference)(a,n):Object(Q.difference)(n,a);var c=a.map(function(e,t){return n[t]&&n[t]===e?{name:e,valid:!0}:{name:e,valid:!1}});return r.a.createElement("div",{style:{}},t.length===o&&o>0&&r.a.createElement("div",{className:"has-text-danger"},r.a.createElement("span",null,"Extra headers - "),t.map(function(e){return r.a.createElement("span",null,'"',e,'" ')})),t.length===Math.abs(o)&&o<0&&r.a.createElement("div",{className:"has-text-danger has-text-weight-bold"},r.a.createElement("span",null,"Missing headers - "),t.map(function(e){return r.a.createElement("span",null,'"',e,'" ')})),r.a.createElement("div",{style:{display:"flex",justifyContent:"space-evenly"}},r.a.createElement("div",null,r.a.createElement("div",{className:"has-text-weight-bold"},"headers "),c.map(function(e,t){return r.a.createElement("div",{key:t,className:e.valid?"has-text-black":"has-text-danger"},e.name)})),r.a.createElement("div",null,r.a.createElement("div",{className:"has-text-weight-bold"},"schema fields"),n.map(function(e,t){return r.a.createElement("div",{key:t},e)}))))},q=a(190),z=a.n(q);var X=Object(s.b)(function(e){return{schema:e.schemaValidation.descriptor&&W(e),flows:e.flows,headerFeedback:e.schemaValidation.headerFeedback}},{importFlows:function(e){return{type:x,payload:e}},setStep:_,validateHeader:function(e){return function(t){var a=e.source,n=e.schema;t({type:I,payload:Object(f.a)({},e,{status:"loading"})}),t(Object(D.a)(N.a.mark(function e(){var r;return N.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,L.Table.load(a.slice(0,2),{schema:n});case 3:return r=e.sent,e.next=6,r.read({limit:1});case 6:t({type:K,payload:{status:"done",valid:!0,headers:r.headers}}),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error(e.t0),"ERROR_HEADER"!==e.t0.type?t({type:K,payload:{status:"done",valid:!0,headers:r.headers}}):t({type:P,valid:!1,status:"done",payload:e.t0});case 13:case"end":return e.stop()}},e,null,[[0,9]])})))}}})(function(e){var t=e.schema,a=e.flows,n=e.headerFeedback,o=e.setStep,c=e.importFlows,s=e.validateHeader;return r.a.createElement("div",null,r.a.createElement(k.DropZone,{maxSize:1e7,onDrop:function(e){var a=Object(w.a)(e,1)[0];"xlsx"===a.name.split(".")[1]?function(e){return new Promise(function(t,a){var n=new FileReader;n.onload=function(e){var a=e.target.result,r=z.a.read(a,{type:"binary"}),o=r.SheetNames[0],c=r.Sheets[o],s=z.a.utils.sheet_to_json(c,{header:1,defval:"",blankrows:!1});t(s),n=void 0},n.onerror=function(e){a(e.target.error),n=void 0},n.readAsBinaryString(e)})}(a).then(function(e){c({file:{name:a.name},data:e}),s({source:e,schema:t})}).catch(function(e){return console.error("fail to parse file")}):function(e){return new Promise(function(t,a){var n=new FileReader;return n.onload=function(a){var r;r="csv"===e.name.split(".")[1]?Object(V.b)(a.target.result):Object(V.c)(a.target.result),t(r),n=void 0},n.onerror=function(e){a(e.target.error),n=void 0},n.readAsText(e)})}(a).then(function(e){c({file:{name:a.name},data:e}),s({source:e,schema:t})}).catch(function(e){return console.error("fail to parse file")})},onDropRejected:function(e,t){console.log("file is invalid")},isSize:"small"},r.a.createElement("span",{className:"tech-info"},"Drag and drop .xlsx, .csv file here(maximum 10MB)")),n&&"loading"===n.status&&r.a.createElement("span",null,"Validating Headers"),n&&n.valid&&r.a.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},r.a.createElement("span",{className:"has-text-success has-text-weight-bold"},'Headers of "',a.file.name,'" are valid'),r.a.createElement(k.Button,{isColor:"info",onClick:function(){return o({id:"1"})}},"Next Step")),n&&!n.valid&&"ERROR_HEADER"===n.type&&r.a.createElement("div",{style:{textAlign:"center"}},r.a.createElement("span",{className:"has-text-danger has-text-weight-bold"},'Headers of "',a.file.name,'" do not match schema fields, please fix your file and re-upload'),r.a.createElement(Y,{headerNames:n.headerNames,fieldNames:n.fieldNames})))}),Z=a(70),$=function(e){var t=e.aggregatedErrors,a=t.foreignKeyErrors,n=t.formatErrors,o=Object.keys(n),c=Object.keys(a);return r.a.createElement("div",{style:{position:"relative",width:"100%",height:"70vh"}},r.a.createElement("div",{style:{position:"absolute",overflowX:"auto",display:"flex",flexFlow:"row nowrap",width:"100%",height:"100%",left:0,top:0,paddingBottom:"1rem"}},o.map(function(e){var t=n[e],a=t.errors.length,o=Object(Q.groupBy)(t.errors,function(e){return e.value}),c=t.constraints&&t.constraints.required?"required":"";return r.a.createElement("div",{key:e,style:{background:"red",height:"100%",minWidth:"10rem",display:"flex",alignItems:"stretch",marginRight:"1rem"}},r.a.createElement(k.ActionCard,{style:{flex:1}},r.a.createElement(k.ActionCardHeader,null,r.a.createElement("td",{style:{width:"100%",display:"inline-block"}},r.a.createElement("b",null,t.name," (",t.type," ",c,") ",a))),r.a.createElement(k.ActionCardBody,null,Object.keys(o).map(function(e,t){var a=o[e];return r.a.createElement("tr",{key:t,style:{display:"flex",justifyContent:"space-between"}},r.a.createElement("td",null,a[0].value),r.a.createElement("td",null,a.length,r.a.createElement(k.HelpPin,{place:"right"},a[0].message)))}))))}),c.map(function(e){var t=a[e],n=t.errors.length,o=Object(Q.groupBy)(t.errors,function(e){return e.value});return r.a.createElement("div",{key:e,style:{background:"red",height:"100%",minWidth:"10rem",display:"flex",alignItems:"stretch",marginRight:"1rem"}},r.a.createElement(k.ActionCard,{style:{flex:1}},r.a.createElement(k.ActionCardHeader,null,r.a.createElement("td",{style:{width:"100%",display:"inline-block"}},r.a.createElement("b",null,t.name," (foreignKey) ",n))),r.a.createElement(k.ActionCardBody,null,Object.keys(o).map(function(e,t){var a=o[e];return r.a.createElement("tr",{key:t,style:{display:"flex",justifyContent:"space-between"}},r.a.createElement("td",null,a[0].value),r.a.createElement("td",null,a.length,r.a.createElement(k.HelpPin,{place:"right"},a[0].message)))}))))})))},ee=function(e){function t(){return Object(l.a)(this,t),Object(u.a)(this,Object(d.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(i.a)(t,[{key:"componentDidMount",value:function(){var e=this.props,t=e.flows,a=e.schema,n=(e.schemaFeedback,e.relations);this.props.validateTable({source:t,schema:a,relations:n})}},{key:"render",value:function(){var e,t=this.props,a=t.flows,n=t.schema,o=t.schemaFeedback,c=(t.relations,n.fields),s=n.foreignKeys,l=c.map(function(e){return e.name}),i=s.map(function(e){return te(e.fields)}),u=["ERROR_FORMAT","ERROR_FOREIGN_KEY"];return o&&o.errors&&(e=function(){var e=c.reduce(function(e,t){return Object(f.a)({},e,Object(Z.a)({},t.name,Object(f.a)({},t,{errors:[]})))},{}),t=s.reduce(function(e,t){var a=te(t.fields);return Object(f.a)({},e,Object(Z.a)({},a,Object(f.a)({name:a},t,{errors:[]})))},{});return o.errors.forEach(function(n){var r=a[n.rowNumber-1],o=n.rowNumber;u.forEach(function(a){var c=n.errors.find(function(e){return e.type===a});"ERROR_FORMAT"===a?l.forEach(function(t,a){c.errors.forEach(function(n){if(n.columnNumber===a+1){var c={rowNumber:o,columnNumber:n.columnNumber,field:t,value:r[a]||"null",message:n.message};e[t].errors.push(c)}})}):"ERROR_FOREIGN_KEY"===a&&i.forEach(function(e){c.errors.forEach(function(a){if(te(a.columnName)===e){var n=a.columnName.map(function(e){var t=l.indexOf(e);return r[t]}),c={rowNumber:o,field:a.columnName,value:n.join("|"),message:a.message};t[e].errors.push(c)}})})})}),Object.keys(e).forEach(function(t){e[t].errors.length||delete e[t]}),Object.keys(t).forEach(function(e){t[e].errors.length||delete t[e]}),{formatErrors:e,foreignKeyErrors:t}}()),r.a.createElement("div",null,o&&"loading"===o.status&&r.a.createElement("span",null,o.loader),o&&!o.valid&&e&&r.a.createElement("div",null,r.a.createElement("span",{className:"has-text-danger has-text-weight-bold"},"Found format errors in ",Object.keys(e.formatErrors).length," columns, ForeignKey errors in ",Object.keys(e.foreignKeyErrors).length," columns, ",o.errors.length," rows"),r.a.createElement($,{aggregatedErrors:e})),o&&o.valid&&r.a.createElement("span",{className:"has-text-success has-text-weight-bold"},"Flows data is valid"))}}]),t}(r.a.Component),te=function(e){return"string"===typeof e?e:e.join("|")},ae=Object(s.b)(function(e){return{flows:e.flows.data,schema:e.schemaValidation.descriptor&&W(e),relations:e.schemaValidation.descriptor&&G(e),foreignKeys:e.schemaValidation.descriptor&&J(e),schemaFeedback:e.schemaValidation.schemaFeedback}},{validateTable:function(e){return function(t){var a=e.source,n=e.schema,r=e.relations;t(Object(D.a)(N.a.mark(function e(){return N.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.delegateYield(N.a.mark(function e(){var o,c,s,l,i;return N.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=a.length,c=100,s=0,l=[],i=N.a.mark(function e(){var o,i,u,d,m;return N.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t({type:B,payload:{status:"loading",loader:"validating ".concat(s," rows")}}),o=s/c,i=[a[0]].concat(a.slice(s+1-o,s+c-o)),e.next=5,L.Table.load(i,{schema:n});case 5:return u=e.sent,e.next=8,u.read({forceCast:!0,relations:r});case 8:d=e.sent,(m=d.filter(function(e){return e.errors})).length&&(m.forEach(function(e){return e.rowNumber=e.rowNumber+c*o-o}),l=l.concat(m));case 11:case"end":return e.stop()}},e)});case 6:if(!(s<o)){e.next=11;break}return e.delegateYield(i(),"t0",8);case 8:s+=c,e.next=6;break;case 11:l.length?t({type:U,payload:{status:"done",valid:!1,errors:l}}):t({type:H,payload:{status:"done",valid:!0}});case 12:case"end":return e.stop()}},e)})(),"t0",2);case 2:e.next=8;break;case 4:e.prev=4,e.t1=e.catch(0),console.error(e.t1),t({type:U,payload:e.t1});case 8:case"end":return e.stop()}},e,null,[[0,4]])})))}}})(ee),ne=function(e){var t=e.steps,a=e.selectedStep,n=e.onSetStep,o=e.children;return r.a.createElement(k.LayoutWrapper,{hasConfig:!0},r.a.createElement(k.LayoutHeader,null,r.a.createElement(k.AppTitle,null,"Ricardo Data App"),r.a.createElement(k.RunningTitle,null,a.title)),r.a.createElement(k.LayoutContainer,null,r.a.createElement(k.LayoutContent,null,r.a.createElement(k.LayoutContentColumn,{isConfig:!0},t.map(function(e,t){var o=a.id===e.id,c=e.id>a.id;return r.a.createElement(k.ButtonContainer,{key:t},r.a.createElement(k.Button,{isColor:o?"info":null,isDisabled:c,onClick:function(){return n(e)}},e.name))})),r.a.createElement(k.LayoutContentColumn,{isWorkspace:!0},o)),r.a.createElement(k.LayoutFooter,null,r.a.createElement(k.LayoutFooterColumn,{isSecondary:!0},r.a.createElement("h3",null,"m\xe9dialab SciencesPo")),r.a.createElement(k.LayoutFooterColumn,{isPrimary:!0},"Ricardo Data App"))))},re=(a(952),Object(s.b)(function(e){return{steps:e.ui.steps,selectedStep:e.ui.selectedStep,repoData:e.repoData}},{setStep:_})(function(e){var t=e.steps,a=e.selectedStep,n=e.repoData,o=e.setStep;return r.a.createElement("div",{className:"App"},r.a.createElement(O,null),n.descriptor&&r.a.createElement(ne,{steps:t,selectedStep:a,onSetStep:o},function(){switch(a.id){case"0":default:return r.a.createElement(X,null);case"1":return r.a.createElement(ae,null)}}()))}));Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var oe=a(32),ce=a(191),se=a(358),le=a(359),ie=Object(oe.c)({ui:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:F,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case S:return Object(f.a)({},e,{selectedStep:R.find(function(e){return a.id===e.id})});default:return e}},flows:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:C,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case x:return a;case A:return Object(f.a)({},e,{data:a.data});default:return e}},schemaValidation:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:M,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case S:return"0"===a.id?Object(f.a)({},e,{schemaFeedback:null,headerFeedback:null}):e;case b:var n={};return Object.keys(a).forEach(function(e){n[e]=Object(V.a)(E.Base64.decode(a[e].content))}),Object(f.a)({},e,{tables:n});case v:return Object(f.a)({},e,{descriptor:JSON.parse(E.Base64.decode(a.content))});case I:case P:case K:return Object(f.a)({},e,{headerFeedback:a});case B:case U:case H:return Object(f.a)({},e,{schemaFeedback:a});default:return e}},repoData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:g,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case b:return Object(f.a)({},e,{tables:a});case v:return Object(f.a)({},e,{datapackage:a,descriptor:JSON.parse(E.Base64.decode(a.content))});default:return e}}}),ue={key:"root",storage:se};Object(ce.a)(ue,ie);var de=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=[le.a],a=oe.d.apply(void 0,[oe.a.apply(void 0,t)].concat([])),n=Object(oe.e)(ie,e,a);return{store:n,persistor:Object(ce.b)(n)}}({}).store;c.a.render(r.a.createElement(s.a,{store:de},r.a.createElement(re,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[361,1,2]]]);
//# sourceMappingURL=main.d00747bd.chunk.js.map