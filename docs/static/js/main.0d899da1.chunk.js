(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{353:function(e,t){},361:function(e,t,a){e.exports=a(953)},372:function(e,t,a){},627:function(e,t){},629:function(e,t){},661:function(e,t){},662:function(e,t){},70:function(e){e.exports={b:"https://raw.githubusercontent.com/medialab/ricardo_data/master",a:"https://api.github.com/repos/medialab/ricardo_data/contents"}},787:function(e,t,a){var n={"./geojson.json":314,"./table-schema.json":788,"./topojson.json":315};function r(e){var t=o(e);return a(t)}function o(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=o,e.exports=r,r.id=787},850:function(e,t,a){var n={"./data-package.json":851,"./data-resource.json":852,"./fiscal-data-package.json":853,"./registry.json":854,"./tabular-data-package.json":855,"./tabular-data-resource.json":856};function r(e){var t=o(e);return a(t)}function o(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=o,e.exports=r,r.id=850},921:function(e,t,a){var n={"./geojson.json":348,"./table-schema.json":922,"./topojson.json":349};function r(e){var t=o(e);return a(t)}function o(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}r.keys=function(){return Object.keys(n)},r.resolve=o,e.exports=r,r.id=921},950:function(e,t){},951:function(e,t){},953:function(e,t,a){"use strict";a.r(t);var n=a(0),r=a.n(n),o=a(86),c=a.n(o),s=a(39),l=(a(372),a(124)),i=a(125),u=a(127),d=a(126),m=a(128),p=a(16),f=a(129),h=a(70),v=a(88),E="FETCH_DATAPACKAGE_SUCCESS",b="FETCH_TABLES_SUCCESS",y=[{name:"sources",path:"data/sources.csv"},{name:"entity_names",path:"data/entity_names.csv"}],g={};var j=function(e){function t(){return Object(l.a)(this,t),Object(u.a)(this,Object(d.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(i.a)(t,[{key:"componentDidMount",value:function(){this.props.fetchDatapackage(),this.props.fetchAllTables({branch:"master"})}},{key:"render",value:function(){var e=this.props.repoData;return r.a.createElement("div",null,!e.tables&&r.a.createElement("span",null,"loading tables"),!e.datapackage&&r.a.createElement("span",null,"loading datapackage"))}}]),t}(r.a.Component),w=Object(s.b)(function(e){return{repoData:e.repoData}},{fetchAllTables:function(e){return function(t){var a=e.branch;t({type:"FETCH_TABLES_REQUEST"}),Promise.all(y.map(function(e){return Object(f.get)("".concat(h.a,"/").concat(e.path,"?ref=").concat(a))})).then(function(e){var a={};e.forEach(function(e){var t=e.data.name.split(".")[0];a[t]=e.data}),t({type:b,payload:a})}).catch(function(a){return t({type:"FETCH_TABLES_FAILURE",payload:e,error:a})})}},fetchDatapackage:function(){return function(e){return e({type:"FETCH_DATAPACKAGE_REQUEST"}),Object(f.get)("".concat(h.a,"/datapackage.json?ref=master")).then(function(t){return e({type:E,payload:t.data})}).catch(function(t){return e({type:"FETCH_DATAPACKAGE_FAILURE",error:t})})}}})(j),O=a(360),k=a(11),A="UPDATE_FLOW",x="IMPORT_FLOWS",S={};var C="SET_STEP",T=function(e){return{type:C,payload:e}},_=[{id:"0",name:"Upload file",title:"Choose a file"},{id:"1",name:"Schema Validation",title:"Schema validation against datapackage"}],D={steps:_,selectedStep:_[0]};var F=a(8),N=a.n(F),R=a(130),L=(a(622),a(357),a(189)),V=a(89),U="VALIDATE_TABLE_REQUEST",B="VALIDATE_TABLE_SUCCESS",H="VALIDATE_TABLE_FAILURE",I="VALIDATE_HEADER_REQUEST",P="VALIDATE_HEADER_SUCCESS",M="VALIDATE_HEADER_FAILURE",W={tableValidated:"flows",schemaFeedback:null,headerFeedback:null,tables:null};var K=function(e){var t=e.schemaValidation.tableValidated;return e.schemaValidation.descriptor.resources.find(function(e){return e.name===t}).schema},J=function(e){var t=Q(e),a={};return t.forEach(function(t){var n=t.reference.resource;a[n]=e.schemaValidation.tables[n]}),a},Q=function(e){var t=e.schemaValidation.tableValidated;return e.schemaValidation.descriptor.resources.find(function(e){return e.name===t}).schema.foreignKeys},G=a(69),q=function(e){var t,a=e.headerNames,n=e.fieldNames,o=a.length-n.length;t=o>0?Object(G.difference)(a,n):Object(G.difference)(n,a);var c=a.map(function(e,t){return n[t]&&n[t]===e?{name:e,valid:!0}:{name:e,valid:!1}});return r.a.createElement("div",{style:{}},t.length===o&&o>0&&r.a.createElement("div",{className:"has-text-danger"},r.a.createElement("span",null,"Extra headers - "),t.map(function(e){return r.a.createElement("span",null,'"',e,'" ')})),t.length===Math.abs(o)&&o<0&&r.a.createElement("div",{className:"has-text-danger has-text-weight-bold"},r.a.createElement("span",null,"Missing headers - "),t.map(function(e){return r.a.createElement("span",null,'"',e,'" ')})),r.a.createElement("div",{style:{display:"flex",justifyContent:"space-evenly"}},r.a.createElement("div",null,r.a.createElement("div",{className:"has-text-weight-bold"},"headers "),c.map(function(e,t){return r.a.createElement("div",{key:t,className:e.valid?"has-text-black":"has-text-danger"},e.name)})),r.a.createElement("div",null,r.a.createElement("div",{className:"has-text-weight-bold"},"schema fields"),n.map(function(e,t){return r.a.createElement("div",{key:t},e)}))))},z=a(190),Y=a.n(z);var X=Object(s.b)(function(e){return{schema:e.schemaValidation.descriptor&&K(e),flows:e.flows,headerFeedback:e.schemaValidation.headerFeedback}},{importFlows:function(e){return{type:x,payload:e}},setStep:T,validateHeader:function(e){return function(t){var a=e.source,n=e.schema;t({type:I,payload:Object(p.a)({},e,{status:"loading"})}),t(Object(R.a)(N.a.mark(function e(){var r;return N.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,L.Table.load(a.slice(0,2),{schema:n});case 3:return r=e.sent,e.next=6,r.read({limit:1});case 6:t({type:P,payload:{status:"done",valid:!0,headers:r.headers}}),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),console.error(e.t0),"ERROR_HEADER"!==e.t0.type?t({type:P,payload:{status:"done",valid:!0,headers:r.headers}}):t({type:M,valid:!1,status:"done",payload:e.t0});case 13:case"end":return e.stop()}},e,null,[[0,9]])})))}}})(function(e){var t=e.schema,a=e.flows,n=e.headerFeedback,o=e.setStep,c=e.importFlows,s=e.validateHeader;return r.a.createElement("div",null,r.a.createElement(k.DropZone,{maxSize:1e7,onDrop:function(e){var a=Object(O.a)(e,1)[0];"xlsx"===a.name.split(".")[1]?function(e){return new Promise(function(t,a){var n=new FileReader;n.onload=function(e){var a=e.target.result,r=Y.a.read(a,{type:"binary"}),o=r.SheetNames[0],c=r.Sheets[o],s=Y.a.utils.sheet_to_json(c,{header:1,defval:"",blankrows:!1});t(s),n=void 0},n.onerror=function(e){a(e.target.error),n=void 0},n.readAsBinaryString(e)})}(a).then(function(e){c({file:{name:a.name},data:e}),s({source:e,schema:t})}).catch(function(e){return console.error("fail to parse file")}):function(e){return new Promise(function(t,a){var n=new FileReader;return n.onload=function(a){var r;r="csv"===e.name.split(".")[1]?Object(V.b)(a.target.result):Object(V.c)(a.target.result),t(r),n=void 0},n.onerror=function(e){a(e.target.error),n=void 0},n.readAsText(e)})}(a).then(function(e){c({file:{name:a.name},data:e}),s({source:e,schema:t})}).catch(function(e){return console.error("fail to parse file")})},onDropRejected:function(e,t){console.log("file is invalid")},isSize:"small"},r.a.createElement("span",{className:"tech-info"},"Drag and drop .xlsx, .csv file here(maximum 10MB)")),n&&"loading"===n.status&&r.a.createElement("span",null,"Validating Headers"),n&&n.valid&&r.a.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},r.a.createElement("span",{className:"has-text-success has-text-weight-bold"},'Headers of "',a.file.name,'" are valid'),r.a.createElement(k.Button,{isColor:"info",onClick:function(){return o({id:"1"})}},"Next Step")),n&&!n.valid&&"ERROR_HEADER"===n.type&&r.a.createElement("div",{style:{textAlign:"center"}},r.a.createElement("span",{className:"has-text-danger has-text-weight-bold"},'Headers of "',a.file.name,'" do not match schema fields, please fix your file and re-upload'),r.a.createElement(q,{headerNames:n.headerNames,fieldNames:n.fieldNames})))}),Z=a(87),$=function(e){var t=e.values,a=void 0===t?[]:t,n=Object.keys(a);return r.a.createElement("div",{style:{position:"relative",width:"100%",height:"70vh"}},r.a.createElement("div",{style:{position:"absolute",overflowX:"auto",display:"flex",flexFlow:"row nowrap",width:"100%",height:"100%",left:0,top:0,paddingBottom:"1rem"}},n.map(function(e){var t=a[e],n=t.errors.length,o=Object(G.groupBy)(t.errors,function(e){return e.value}),c=t.constraints&&t.constraints.required?"required":"";return r.a.createElement("div",{key:e,style:{background:"red",height:"100%",minWidth:"10rem",display:"flex",alignItems:"stretch",marginRight:"1rem"}},r.a.createElement(k.ActionCard,{style:{flex:1}},r.a.createElement(k.ActionCardHeader,null,r.a.createElement("td",{style:{width:"100%",display:"inline-block"}},r.a.createElement("b",null,t.name," (",t.type," ",c,") ",n))),r.a.createElement(k.ActionCardBody,null,Object.keys(o).map(function(e,t){var a=o[e];return r.a.createElement("tr",{key:t,style:{display:"flex",justifyContent:"space-between"}},r.a.createElement("td",null,a[0].value),r.a.createElement("td",null,a.length,r.a.createElement(k.HelpPin,{place:"right"},a[0].message)))}))))})))},ee=function(e){function t(){return Object(l.a)(this,t),Object(u.a)(this,Object(d.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(i.a)(t,[{key:"componentDidMount",value:function(){var e=this.props,t=e.flows,a=e.schema,n=(e.schemaFeedback,e.relations);this.props.validateTable({source:t,schema:a,relations:n})}},{key:"render",value:function(){var e,t=this.props,a=t.flows,n=t.schema,o=t.schemaFeedback,c=(t.relations,n.fields),s=c.map(function(e){return e.name});return o&&o.errors&&(e=function(){var e=c.reduce(function(e,t){return Object(p.a)({},e,Object(Z.a)({},t.name,Object(p.a)({},t,{errors:[]})))},{});return o.errors.forEach(function(t){var n=a[t.rowNumber-1],r=t.rowNumber,o=t.errors.find(function(e){return"ERROR_FORMAT"===e.type});s.forEach(function(t,a){o.errors.forEach(function(o){if(o.columnNumber===a+1){var c={rowNumber:r,columnNumber:o.columnNumber,field:t,value:n[a]||"null",message:o.message};e[t].errors.push(c)}})})}),Object.keys(e).forEach(function(t){e[t].errors.length||delete e[t]}),e}()),r.a.createElement("div",null,o&&"loading"===o.status&&r.a.createElement("span",null,o.loader),o&&!o.valid&&e&&r.a.createElement("div",null,r.a.createElement("span",{className:"has-text-danger has-text-weight-bold"},"Found format errors in ",Object.keys(e).length," columns, ",o.errors.length," rows"),r.a.createElement($,{values:e})),o&&o.valid&&r.a.createElement("span",{className:"has-text-success has-text-weight-bold"},"Flows data is valid"))}}]),t}(r.a.Component),te=Object(s.b)(function(e){return{flows:e.flows.data,schema:e.schemaValidation.descriptor&&K(e),relations:e.schemaValidation.descriptor&&J(e),foreignKeys:e.schemaValidation.descriptor&&Q(e),schemaFeedback:e.schemaValidation.schemaFeedback}},{validateTable:function(e){return function(t){var a=e.source,n=e.schema;e.relations,t(Object(R.a)(N.a.mark(function e(){return N.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.delegateYield(N.a.mark(function e(){var r,o,c,s,l;return N.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=a.length,o=100,c=0,s=[],l=N.a.mark(function e(){var r,l,i,u,d;return N.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t({type:U,payload:{status:"loading",loader:"validating ".concat(c," rows")}}),r=c/o,l=[a[0]].concat(a.slice(c+1-r,c+o-r)),e.next=5,L.Table.load(l,{schema:n});case 5:return i=e.sent,e.next=8,i.read({forceCast:!0});case 8:u=e.sent,(d=u.filter(function(e){return e.errors})).length&&(d.forEach(function(e){return e.rowNumber=e.rowNumber+o*r-r}),s=s.concat(d));case 11:case"end":return e.stop()}},e)});case 6:if(!(c<r)){e.next=11;break}return e.delegateYield(l(),"t0",8);case 8:c+=o,e.next=6;break;case 11:s.length?t({type:H,payload:{status:"done",valid:!1,errors:s}}):t({type:B,payload:{status:"done",valid:!0}});case 12:case"end":return e.stop()}},e)})(),"t0",2);case 2:e.next=8;break;case 4:e.prev=4,e.t1=e.catch(0),console.error(e.t1),t({type:H,payload:e.t1});case 8:case"end":return e.stop()}},e,null,[[0,4]])})))}}})(ee),ae=function(e){var t=e.steps,a=e.selectedStep,n=e.onSetStep,o=e.children;return r.a.createElement(k.LayoutWrapper,{hasConfig:!0},r.a.createElement(k.LayoutHeader,null,r.a.createElement(k.AppTitle,null,"Ricardo Data App"),r.a.createElement(k.RunningTitle,null,a.title)),r.a.createElement(k.LayoutContainer,null,r.a.createElement(k.LayoutContent,null,r.a.createElement(k.LayoutContentColumn,{isConfig:!0},t.map(function(e,t){var o=a.id===e.id,c=e.id>a.id;return r.a.createElement(k.ButtonContainer,{key:t},r.a.createElement(k.Button,{isColor:o?"info":null,isDisabled:c,onClick:function(){return n(e)}},e.name))})),r.a.createElement(k.LayoutContentColumn,{isWorkspace:!0},o)),r.a.createElement(k.LayoutFooter,null,r.a.createElement(k.LayoutFooterColumn,{isSecondary:!0},r.a.createElement("h3",null,"m\xe9dialab SciencesPo")),r.a.createElement(k.LayoutFooterColumn,{isPrimary:!0},"Ricardo Data App"))))},ne=(a(952),Object(s.b)(function(e){return{steps:e.ui.steps,selectedStep:e.ui.selectedStep,repoData:e.repoData}},{setStep:T})(function(e){var t=e.steps,a=e.selectedStep,n=e.repoData,o=e.setStep;return r.a.createElement("div",{className:"App"},r.a.createElement(w,null),n.descriptor&&r.a.createElement(ae,{steps:t,selectedStep:a,onSetStep:o},function(){switch(a.id){case"0":default:return r.a.createElement(X,null);case"1":return r.a.createElement(te,null)}}()))}));Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var re=a(32),oe=a(191),ce=a(358),se=a(359),le=Object(re.c)({ui:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:D,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case C:return Object(p.a)({},e,{selectedStep:_.find(function(e){return a.id===e.id})});default:return e}},flows:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:S,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case x:return a;case A:return Object(p.a)({},e,{data:a.data});default:return e}},schemaValidation:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:W,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case C:return"0"===a.id?Object(p.a)({},e,{schemaFeedback:null,headerFeedback:null}):e;case b:var n={};return Object.keys(a).forEach(function(e){n[e]=Object(V.a)(v.Base64.decode(a[e].content))}),Object(p.a)({},e,{tables:n});case E:return Object(p.a)({},e,{descriptor:JSON.parse(v.Base64.decode(a.content))});case I:case M:case P:return Object(p.a)({},e,{headerFeedback:a});case U:case H:case B:return Object(p.a)({},e,{schemaFeedback:a});default:return e}},repoData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:g,t=arguments.length>1?arguments[1]:void 0,a=t.payload;switch(t.type){case b:return Object(p.a)({},e,{tables:a});case E:return Object(p.a)({},e,{datapackage:a,descriptor:JSON.parse(v.Base64.decode(a.content))});default:return e}}}),ie={key:"root",storage:ce};Object(oe.a)(ie,le);var ue=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=[se.a],a=re.d.apply(void 0,[re.a.apply(void 0,t)].concat([])),n=Object(re.e)(le,e,a);return{store:n,persistor:Object(oe.b)(n)}}({}).store;c.a.render(r.a.createElement(s.a,{store:ue},r.a.createElement(ne,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[361,1,2]]]);
//# sourceMappingURL=main.0d899da1.chunk.js.map